---
title: "Statistical report: The role of CRT as enables for optimizing guideline directed medical therapy (GDMT) in patients with heart failure and reduced ejection fraction (HFrEF): data from the SwedeHF Registry"
subtitle: "Draft"
date: "`r Sys.Date()`"
cover: static/ki_logo_vert_rgb.png
editor: source
format:
  pdf:
    documentclass: scrartcl
    template-partials:
      - "static/before-body.tex"
      - "static/_titlepage.tex"
    include-in-header: 
      - "static/in-header.tex"
    toc: true
    toc-depth: 3
    toc-title: Contents
    lof: true
    lot: true
    cap-location: top
    number-sections: true
    colorlinks: false
    keep-tex: false
bibliography: static/references.bib
csl: static/bmj.csl
link-citations: true
link-bibliography: true
nocite: '@*'
knitr:
  opts_chunk: 
    dev: cairo_pdf
    collapse: true
    comment: "" 
    echo: FALSE
    include: TRUE
    warning: FALSE
    message: FALSE
    fig.pos: "H"
    fig.path: "../output/figs/"
    fig.height: 6
    fig.width: 10
    R.options:
      knitr.graphics.auto_pdf: true
---

```{r}
#| label: set-up-load-data
options(knitr.kable.NA = "")

# load packages, globals and project specific functions
source(here::here("setup/setup.R"))

# load data
load(here("data/clean-data/data.RData"))

# load workbook to write tables to Excel
wb <- loadWorkbook(here("output/tabs/tables.xlsx"))
sheets <- names(wb)

# load pptx file with figs
figs <- officer::read_pptx(path = here::here("output/figs/figs.pptx"))
```           

\newpage

# Data

## Data sources

The Swedish Heart Failure Registry (SwedeHF) is an ongoing nationwide quality registry started in 2000, 
that includes in- and out-hospital patients with HF, regardless of EF and previous history of HF[@swedehf]. 
Around 80 variables are recorded at 
discharge from hospital or at the outpatient visit, i.e. index date, and 
entered into an electronic database managed by the Uppsala Clinical Research 
Center (Uppsala, Sweden). Up to April 2017 the only inclusion criterion was a 
clinical diagnosis of HF, which was thereafter defined according to the ICD-10 
codes I50.0, I50.1, I50.9, I42.0, I42.6, I42.7, I25.5, I11.0, I13.0, I13.2. 
In 2021, 69 of 76 Swedish hospitals enrolled patients in SwedeHF, which had a 32% coverage of the prevalent HF population in Sweden[@annualreport]. 

SwedeHF was linked with national Swedish registries (SHFDB version 4.1.2) through the 
Swedish personal identity number (PIN)[@pin]: 

- The ICD/PM Registry
- The National Patient Register (The National Board of Health and Welfare) for 
additional comorbidities and the hospitalization outcomes
- The National Prescribed Drug Register (The National Board of Health and Welfare) 
for medications
- The Cause of Death Register[@dors] (The National Board of Health and Welfare) for outcomes 
death
- Longitudinal integrated database for health insurance and labour market studies (LISA)[@lisa] 
and the Register of the Total Population (Statistics Sweden) for socio-economic factors

## Acknowledgments

Please include "We thank all staff members at care units reporting into the SwedeHF registry for their contribution." 
in the Acknowledgements of any resulting articles. 

## Ethics and Informed consent

The study was approved by the Swedish Ethical Review Authority, dnr 2021-04326. 
Individual consent was not required, but patients were informed of entry into SwedeHF and able to opt‐out.

\newpage

## Inclusion/exclusion criteria

```{r}
#| label: tbl-flow
#| tbl-cap: Information for flowchart
default_kable(flow) %>%
  row_spec(c(1, 11), bold = T) %>%
  column_spec(1, width = "15cm")
```

## Definitions

Information on data sources, definitions etc. are found https://kiheartfailure.github.io/shfdb4/.

{{< include src/vars.qmd >}}

\clearpage

### Baseline (index date)

Baseline is defined as date of discharge or, if missing, date of admittance/visit for the 
first encounter in NPR with CRT for the CRT population and registration in SwedeHF for the controls. 
If multiple SwedeHF registrations exists, the registration closest to CRT (within 1 year) is selected. 

### GDMT

GDMT at baseline are defined as a dispensed prescription in NPDR 4 months prior up until day before baseline. 

GDMT at 1 year follow-up are defined as a dispensed prescription in NPDR 12 months $\pm$ 2 months after baseline. 

The prescription closest to baseline and 1 year is chosen if multiple prescriptions exist. 

PLEASE CHECK MY SUGGESTED DEFINITION BELOW:

The difference between baseline and 1 year follow-up is defined as: 

- No change: If the patient is not on medication at baseline and not on medication at fu OR no change in achieved % target dose
- Increase: If the patient is not on medication at baseline and on medication at fu OR increase in achieved % target dose
- Decrease: If the patient is on medication at baseline and not on medication at fu OR decrease in achieved % target dose

For the combined GDMT variable the sum of the 3 individual medications is calculated (No change: 0, Increase: 1, Decrease: -1) 
and if the summarized variable is 0 = No change, >0: Increase, <0: Decrease. 

# Statistical analysis 

## General

All analyses were performed using `r sessionInfo()$R.version$version.string` [@r]. 
The level of significance is set to 5%, two-sided. No adjustment for multiple 
comparisons were made and therefore the results should be viewed with care.

## Missing data

Missing data was imputed with multiple imputation (n = 10) using mice [@mice] 
and Rubin’s rules was used for combining estimates and standard errors across imputed data sets. 
Variables included in the model are indicated in @tbl-base. CRT and GDMT were not included in the model. 

## Baseline characteristics

Baseline characteristics are presented by CRT/Controls. 
Categorical variables are presented with n and percentage and tested for 
differences between groups with the chi-square test. 
Continuous variables are presented with median [first quartile-third quartile] and tested for 
differences between groups with the Kruskal-Wallis test. 

## GDMT

For the predictors model No change and decrease are combined. OK???? Or do you want to keep 3 levels? Should this only be for patients with CRT (looks like that from the project plan but perhaps also the controls should be included as a comparison)??? 

The association between baseline characteristics and the respective change in GDMT together with the combined GDMT was evaluated using a multivariable logistic regression 
including the variables shown in @fig-predictors. The variables were selected based on clinical relevance. 

If both CRT and control patients with interaction effect.... Note that this causes the estimates to be from different multivariable models.  

### Assumptions

Possible outliers were evaluated using Cook's distance and multicollinearity was 
evaluated using the Variance Inflation Factor (VIF) XXX. 

# Results

```{r}
med <- rsdata %>%
  summarise(
    med = fn(median(shf_age), dig = 0),
    q1 = fn(quantile(shf_age, probs = 0.25), dig = 0),
    q3 = fn(quantile(shf_age, probs = 0.75), dig = 0)
  ) %>%
  mutate(out = paste0(med, " (", q1, "-", q3, ")")) %>%
  pull(out)

percfem <- rsdata %>%
  count(shf_sex) %>%
  mutate(perc = fn(n / sum(n) * 100, 0)) %>%
  filter(shf_sex == "Female") %>%
  pull(perc)
```

The median (q1-q3) age is `r med` and `r percfem`% females.    

## Baseline characteristics

{{< include src/base_tab.qmd >}}

\clearpage

## GDMT

{{< include src/medbase_tab.qmd >}}

Ok with the below plot instead of those suggested in project plan?;

{{< include src/bar.qmd >}}

## Predictors of increase in GDMT

Either a table or a Forestplot?

\clearpage

# Reproducibility

## R code

The R code for all data handling and statistical analyses are found: 

https://github.com/KIHeartFailure/crt-gdmt. On publication
the repository will be made public so as to 
link to it from the resulting article for increased transparency and code sharing.
No data or output is stored in the repository. 

## R session information {#sessioninfo}

```{r sessinfo}
sessionInfo()
```

# References

::: {#refs}
:::
